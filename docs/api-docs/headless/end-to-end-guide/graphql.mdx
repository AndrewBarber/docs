# End-to-End Guide: Headless Checkout Flow with GraphQL APIs

BigCommerce provides GraphQL Storefront APIs for managing cart and checkout objects to build storefront functionality. The GraphQL APIs provide the same use cases as our Cart and Checkout REST Management APIs but have the added benefit of making it easier to build headless storefront applications. Developers using GraphQL can spend less time focusing on API interactions and more time building the shopper experience.

This end-to-end tutorial targets developers who want to build a custom headless storefront. The tutorial walks you through critical GraphQL capabilities to fit most use cases when creating a headless storefront:

* creating a token
* querying product data
* creating a cart
* adding cart line items
* getting a [Checkout](/docs/rest-management/checkouts)
* adding a checkout billing address
* adding a checkout shipping consignment
* selecting shipping option
* completing a checkout 

## Prerequisites

To complete the guide, you will need the following:
* [BigCommerce sandbox store](https://start.bigcommerce.com/developer-sandbox/) 
* Familarity with creating a channel and a site

## Create a customer impersonation token

Before getting started, create a token allowing you to make GraphQL POST requests as a customer. This type of token is the most appropriate for an application that will make server-to-server requests to the GraphQL Storefront API. This guide will use this authentication method. You could create and use a Storefront API Token to authenticate requests to the GraphQL Storefront API if you prefer to use tokens that expire. For more creating a Storefront API Token, see [Create a Token](https://developer.bigcommerce.com/docs/rest-authentication/tokens#create-a-token). 

To generate a [customer impersonation token](/docs/rest-authentication/tokens#customer-impersonation-tokens), send a POST request to `/v3/storefront/api-token-customer-impersonation`.

 ```http
POST https://api.bigcommerce.com/stores/{STORE_HASH}/v3/storefront/api-token-customer-impersonation
X-Auth-Token: {{ACCESS_TOKEN}}
Accept: application/json
Content-Type: application/json

{
  "channel_id": 1, 
  "expires_at": 1602288000 
}
```

[**Response:**](/docs/rest-authentication/tokens/customer-impersonation-token#create-a-token)

```json
  {
    "data":
      {
        "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"
      }
      "meta": {}
  }
```

## Querying product data

The GraphQL Storefront API lets you retrieve product data from a store. The following example demostrates how to query a simple product using the GraphQL Storefront API. For more information and examples, see the [Guide to Working with Products](/docs/storefront/graphql/examples/products).

<Callout type="info">
#### Query best practices
* Query less than 50 resources at a time.
* Limit query complexity where possible.
* Limit pagination where possible.
* Employ security practices and limit scope where possible.
* Employ caching where possible.
</Callout>

```graphql filename="Get a product" showLineNumbers copy
# This query retrieves one product.

query SingleProduct {
  site {
    product (entityId: ${params.id}) {
      id
      entityId
      name
      sku
      description
      prices {
        price {
          value
          currencyCode
        }
      }
    }
  }
}
```

## Creating a cart

BigCommerce's GraphQL Storefront API provides the same access to cart and checkout objects as the REST Storefront API. The example below shows how to create a new cart by adding a simple product.

<Tabs items={['Request', 'Response']}>
  <Tab>
    
    ```graphql filename="Example mutation: Create a cart (simple)" showLineNumbers copy 
    # Creates a new cart, adding a simple product.
    # In the GraphQL Playground, this will fail if you already have a cart.

    mutation createCartSimple($createCartInput: CreateCartInput!) {
      cart {
        createCart(input: $createCartInput) {
          cart {
            entityId
            lineItems {
              physicalItems {
                name
                quantity
              }
              digitalItems {
                name
                quantity
              }
              giftCertificates {
                name
              }
              customItems {
                name
                quantity
              }
            }
          }
        }
      }
    }
    ```

    ```json filename="GraphQL variables" showLineNumbers copy 
    {
      "createCartInput": {
        "lineItems": [
          {
            "quantity": 1,
            "productEntityId": 111
          }
        ]
      }
    }
    ```
  </Tab>
  <Tab>
   
    ```json filename="Example mutation: Create a cart (simple)" showLineNumbers copy
    {
      "data": {
        "cart": {
          "createCart": {
            "cart": {
              "entityId": "bb916deb-ddd6-4586-b65b-b8385e0e7a9d",
              "lineItems": {
                "physicalItems": [
                  {
                    "name": "[Sample] Smith Journal 13",
                    "quantity": 1
                  }
                ],
                "digitalItems": [],
                "giftCertificates": [],
                "customItems": []
              }
            }
          }
        }
      }
    }
    ```
  </Tab>
</Tabs>

## Add cart line items

To add a new line item to the existing cart, add the cart ID to the GraphQL variables or the mutation will fail.

<Tabs items={['Request', 'Response']}>
  <Tab>
    
    ```graphql filename="Example mutation: Add cart line items" showLineNumbers copy
    mutation addCartLineItems($addCartLineItemsInput: AddCartLineItemsInput!) {
      cart {
        addCartLineItems(input: $addCartLineItemsInput) {
          cart {
            entityId
          }
        }
      }
    }
    ```

    ```json filename="GraphQL variables" showLineNumbers copy 
    {
      "addCartLineItemsInput": {
        "cartEntityId": "bb916deb-ddd6-4586-b65b-b8385e0e7a9d",
        "data": {
          "lineItems": [
            {
              "quantity": 1,
              "productEntityId": 107
            }
          ]
        }
      }
    }
    ```
  </Tab>
  <Tab>
    
    ```json filename="Example mutation: Add cart line item" showLineNumbers copy
    {
      "data": {
        "cart": {
          "addCartLineItems": {
            "cart": {
              "entityId": "bb916deb-ddd6-4586-b65b-b8385e0e7a9d"
            }
          }
        }
      }
    }
    ```
  </Tab>
</Tabs>

## Get a checkout



<Tabs items={['Request', 'Response']}>
  <Tab>
    
    ```graphql filename="Example query: Get checkout" showLineNumbers copy
    query getCheckout {
      site {
        checkout {
          entityId
          billingAddress {
            ...CheckoutBillingAddressFields
          }
          shippingConsignments {
            ...CheckoutShippingConsignmentFields
          }
          order {
            entityId
          }
          shippingCostTotal {
            ...MoneyFields
          }
          giftWrappingCostTotal {
            ...MoneyFields
          }
          handlingCostTotal {
            ...MoneyFields
          }
          taxTotal {
            ...MoneyFields
          }
          taxes {
            ...CheckoutTaxFields
          }
          subtotal {
            ...MoneyFields
          }
          grandTotal {
            ...MoneyFields
          }
          createdAt {
            utc
          }
          updatedAt {
            utc
          }
          customerMessage
          outstandingBalance {
            ...MoneyFields
          }
          coupons {
            ...CheckoutCouponFields
          }
          promotions {
            ...CheckoutPromotionFields
          }
        }
      }
    }

    fragment CheckoutConsignmentAddressFields on CheckoutConsignmentAddress {
      ...CheckoutAddressFields
    }

    fragment CheckoutBillingAddressFields on CheckoutBillingAddress {
      entityId
      ...CheckoutAddressFields
    }

    fragment CheckoutAddressFields on CheckoutAddress {
      firstName
      lastName
      email
      company
      address1
      address2
      city
      stateOrProvince
      stateOrProvinceCode
      countryCode
      postalCode
      phone
      customFields {
        entityId
        ... on CheckoutAddressCheckboxesCustomField {
          valueEntityIds
        }
        ... on CheckoutAddressDateCustomField {
          date {
            utc
          }
        }
        ... on CheckoutAddressMultipleChoiceCustomField {
          valueEntityId
        }
        ... on CheckoutAddressNumberCustomField {
          number
        }
        ... on CheckoutAddressPasswordCustomField {
          password
        }
        ... on CheckoutAddressTextFieldCustomField {
          text
        }
      }
    }

    fragment CheckoutShippingConsignmentFields on CheckoutShippingConsignment {
      entityId
      address {
        ...CheckoutConsignmentAddressFields
      }
      availableShippingOptions {
        ...CheckoutAvailableShippingOptionFields
      }
      selectedShippingOption {
        ...CheckoutSelectedShippingOptionFields
      }
      coupons {
        ...CheckoutCouponFields
      }
      shippingCost {
        ...MoneyFields
      }
      handlingCost {
        ...MoneyFields
      }
      lineItemIds
    }

    fragment CheckoutAvailableShippingOptionFields on CheckoutAvailableShippingOption {
      entityId
      description
      type
      imageUrl
      cost {
        ...MoneyFields
      }
      transitTime
      isRecommended
    }

    fragment CheckoutSelectedShippingOptionFields on CheckoutSelectedShippingOption {
      entityId
      description
      type
      imageUrl
      cost {
        ...MoneyFields
      }
      transitTime
    }

    fragment MoneyFields on Money {
      value
      currencyCode
    }

    fragment CheckoutCouponFields on CheckoutCoupon {
      entityId
      code
      couponType
      discountedAmount {
        ...MoneyFields
      }
    }

    fragment CheckoutTaxFields on CheckoutTax {
      name
      amount {
        ...MoneyFields
      }
    }

    fragment CheckoutPromotionFields on CheckoutPromotion {
      banners {
        entityId
        type
        locations
        text
      }
    }
    ```
  </Tab>
  <Tab>
    
    ```json filename="Example query: Get checkout" showLineNumbers copy   
    {
      "data": {
        "site": {
          "checkout": {
            "entityId": "bb916deb-ddd6-4586-b65b-b8385e0e7a9d",
            "billingAddress": null,
            "shippingConsignments": [],
            "order": null,
            "shippingCostTotal": {
              "value": 0,
              "currencyCode": "USD"
            },
            "giftWrappingCostTotal": {
              "value": 0,
              "currencyCode": "USD"
            },
            "handlingCostTotal": {
              "value": 0,
              "currencyCode": "USD"
            },
            "taxTotal": {
              "value": 0,
              "currencyCode": "USD"
            },
            "taxes": [
              {
                "name": "Tax",
                "amount": {
                  "value": 0,
                  "currencyCode": "USD"
                }
              }
            ],
            "subtotal": {
              "value": 59.95,
              "currencyCode": "USD"
            },
            "grandTotal": {
              "value": 59.95,
              "currencyCode": "USD"
            },
            "createdAt": {
              "utc": "2023-06-01T17:45:23Z"
            },
            "updatedAt": {
              "utc": "2023-06-01T19:07:15Z"
            },
            "customerMessage": "",
            "outstandingBalance": {
              "value": 59.95,
              "currencyCode": "USD"
            },
            "coupons": [],
            "promotions": []
          }
        }
      }
    }
    ```
  </Tab>
</Tabs>
